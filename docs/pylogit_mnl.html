---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "01_pylogit_mnl.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_pylogit_mnl.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pylogit</span> <span class="k">as</span> <span class="nn">pl</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Swiss-metro-data">Load Swiss metro data<a class="anchor-link" href="#Load-Swiss-metro-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sm_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/swissmetro_long.csv&quot;</span><span class="p">)</span>
<span class="n">sm_long</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(19143, 22)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-the-model-specification">Create the model specification<a class="anchor-link" href="#Create-the-model-specification"> </a></h3><p>The model specification being used in this example is the following:
$$
\begin{aligned}
V_{i, \textrm{Train}} &amp;= \textrm{ASC Train} + \\
&amp;\quad \beta _{ \textrm{tt_train} } \textrm{Travel Time} _{ \textrm{Train}} + \\
&amp;\quad \beta _{ \textrm{tc_train} } \textrm{Travel Cost}_{\textrm{Train}} * \left( GA == 0 \right) + \\
&amp;\quad \beta _{ \textrm{headway_train} } \textrm{Headway} _{\textrm{Train}} \\
\\
V_{i, \textrm{Swissmetro}} &amp;= \textrm{ASC Swissmetro} + \\
&amp;\quad \beta _{ \textrm{tt_sm} } \textrm{Travel Time} _{ \textrm{Swissmetro}} + \\
&amp;\quad \beta _{ \textrm{tc_sm} } \textrm{Travel Cost}_{\textrm{Swissmetro}} * \left( GA == 0 \right) + \\
&amp;\quad \beta _{ \textrm{headway_sm} } \textrm{Heaway} _{\textrm{Swissmetro}} \\
% &amp;\quad \beta _{ \textrm{seat} } \left( \textrm{Seat Configuration} == 1 \right) \\
% &amp;\quad \beta _{ \textrm{survey} } \left( \textrm{Train Survey} == 1 \right) \\
% &amp;\quad \beta _{ \textrm{first_class} } \left( \textrm{First Class} == 0 \right) \\
\\
V_{i, \textrm{Car}} &amp;= \beta _{ \textrm{tt_car} } \textrm{Travel Time} _{ \textrm{Car}} + \\
&amp;\quad \beta _{ \textrm{tc_car}} \textrm{Travel Cost}_{\textrm{Car}} \\
% &amp;\quad \beta _{\textrm{luggage}=1} \left( \textrm{Luggage} == 1 \right) + \\
% &amp;\quad \beta _{\textrm{luggage}&gt;1} \left( \textrm{Luggage} &gt; 1 \right)
\end{aligned}
$$</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># sm_long[&quot;travel_time&quot;] = sm_long[&quot;travel_time&quot;] </span>
<span class="c1"># Get free_ticket</span>
<span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;free_ticket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;GA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;WHO&quot;</span><span class="p">]</span><span class="o">/</span> <span class="mf">100.0</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
                            <span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;mode_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># Update travel cost</span>
<span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;free_ticket&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spec</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;travel_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;headway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sm_mnl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">create_choice_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sm_long</span><span class="p">,</span>
                                <span class="n">alt_id_col</span><span class="o">=</span><span class="s2">&quot;mode_id&quot;</span><span class="p">,</span>
                                <span class="n">obs_id_col</span><span class="o">=</span><span class="s2">&quot;custom_id&quot;</span><span class="p">,</span>
                                <span class="n">choice_col</span><span class="o">=</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">,</span>
                                <span class="n">specification</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;MNL&quot;</span><span class="p">)</span>

<span class="c1"># Specify the initial values and method for the optimization.</span>
<span class="n">sm_mnl</span><span class="o">.</span><span class="n">fit_mle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Look at the estimation results</span>
<span class="n">sm_mnl</span><span class="o">.</span><span class="n">get_statsmodels_summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Log-likelihood at zero: -6,964.6630
Initial Log-likelihood: -6,964.6630
Estimation Time for Point Estimation: 0.07 seconds.
Final log-likelihood: -5,060.4258
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/danph/anaconda3/envs/ml-dchoice/lib/python3.7/site-packages/scipy/optimize/_minimize.py:523: RuntimeWarning: Method BFGS does not use Hessian information (hess).
  RuntimeWarning)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<table class="simpletable">
<caption>Multinomial Logit Model Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>         <td>CHOICE</td>          <th>  No. Observations:  </th>    <td>6,768</td>  
</tr>
<tr>
  <th>Model:</th>         <td>Multinomial Logit Model</td> <th>  Df Residuals:      </th>    <td>6,758</td>  
</tr>
<tr>
  <th>Method:</th>                  <td>MLE</td>           <th>  Df Model:          </th>     <td>10</td>    
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 11 Mar 2021</td>     <th>  Pseudo R-squ.:     </th>    <td>0.273</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>18:12:33</td>         <th>  Pseudo R-bar-squ.: </th>    <td>0.272</td>  
</tr>
<tr>
  <th>AIC:</th>                 <td>10,140.852</td>        <th>  Log-Likelihood:    </th> <td>-5,060.426</td>
</tr>
<tr>
  <th>BIC:</th>                 <td>10,209.051</td>        <th>  LL-Null:           </th> <td>-6,964.663</td>
</tr>
</table>
<table class="simpletable">
<tr>
        <td></td>           <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>intercept_1</th>   <td>    0.6291</td> <td>    0.143</td> <td>    4.408</td> <td> 0.000</td> <td>    0.349</td> <td>    0.909</td>
</tr>
<tr>
  <th>intercept_2</th>   <td>    0.5003</td> <td>    0.110</td> <td>    4.567</td> <td> 0.000</td> <td>    0.286</td> <td>    0.715</td>
</tr>
<tr>
  <th>travel_time_1</th> <td>   -0.0088</td> <td>    0.001</td> <td>  -10.608</td> <td> 0.000</td> <td>   -0.010</td> <td>   -0.007</td>
</tr>
<tr>
  <th>travel_time_2</th> <td>   -0.0111</td> <td>    0.001</td> <td>  -12.739</td> <td> 0.000</td> <td>   -0.013</td> <td>   -0.009</td>
</tr>
<tr>
  <th>travel_time_3</th> <td>   -0.0129</td> <td>    0.001</td> <td>  -15.943</td> <td> 0.000</td> <td>   -0.014</td> <td>   -0.011</td>
</tr>
<tr>
  <th>travel_cost_1</th> <td>   -0.0309</td> <td>    0.001</td> <td>  -25.817</td> <td> 0.000</td> <td>   -0.033</td> <td>   -0.029</td>
</tr>
<tr>
  <th>travel_cost_2</th> <td>   -0.0112</td> <td>    0.001</td> <td>  -20.613</td> <td> 0.000</td> <td>   -0.012</td> <td>   -0.010</td>
</tr>
<tr>
  <th>travel_cost_3</th> <td>   -0.0080</td> <td>    0.001</td> <td>   -7.499</td> <td> 0.000</td> <td>   -0.010</td> <td>   -0.006</td>
</tr>
<tr>
  <th>headway_1</th>     <td>   -0.0052</td> <td>    0.001</td> <td>   -4.958</td> <td> 0.000</td> <td>   -0.007</td> <td>   -0.003</td>
</tr>
<tr>
  <th>headway_2</th>     <td>   -0.0072</td> <td>    0.003</td> <td>   -2.209</td> <td> 0.027</td> <td>   -0.014</td> <td>   -0.001</td>
</tr>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluation-metrics">Evaluation metrics<a class="anchor-link" href="#Evaluation-metrics"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">classification_report</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">model_pred</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alt_id_col</span><span class="p">,</span> <span class="n">obs_id_col</span><span class="p">,</span> <span class="n">choice_col</span><span class="p">):</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">is_chosen</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">obs_id_col</span><span class="p">])[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_choice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_chosen</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s1">&#39;predicted_choice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">actual</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">choice_column</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alt_id_column</span><span class="p">]</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_choice&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alt_id_column</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">actual</span><span class="p">,</span> <span class="n">pred</span>   

<span class="k">def</span> <span class="nf">nll</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="n">alt_id_column</span> <span class="o">=</span> <span class="s2">&quot;mode_id&quot;</span>
<span class="n">obs_id_column</span> <span class="o">=</span> <span class="s2">&quot;custom_id&quot;</span>
<span class="n">choice_column</span> <span class="o">=</span> <span class="s2">&quot;CHOICE&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="MNL-model-results">MNL model results<a class="anchor-link" href="#MNL-model-results"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">model_pred</span><span class="p">(</span><span class="n">sm_long</span><span class="p">,</span> <span class="n">sm_mnl</span><span class="p">,</span> <span class="n">alt_id_column</span><span class="p">,</span> <span class="n">obs_id_column</span><span class="p">,</span> <span class="n">choice_column</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>              precision    recall  f1-score   support

           1       0.60      0.04      0.08       908
           2       0.67      0.92      0.78      4090
           3       0.69      0.42      0.52      1770

    accuracy                           0.67      6768
   macro avg       0.65      0.46      0.46      6768
weighted avg       0.67      0.67      0.62      6768

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">),</span> 
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">, F1_score = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Accuracy = [0.67317], F1_score = 0.61607
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h6 id="#">#<a class="anchor-link" href="##"> </a></h6>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simple-MNL-as-in-1.logit-Biogeme">Simple MNL as in 1.logit Biogeme<a class="anchor-link" href="#Simple-MNL-as-in-1.logit-Biogeme"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model specification being used in this example is the following:
$$
\begin{aligned}
V_{i, \textrm{Train}} &amp;= \textrm{ASC Train}  + \\
&amp;\quad \beta _{ \textrm{tt} } \textrm{Travel Time} _{ \textrm{Train}} + \\
&amp;\quad \beta _{ \textrm{tc} } \textrm{Travel Cost}_{\textrm{Train}} * \left( GA == 0 \right) + \\
\\
V_{i, \textrm{Swissmetro}} &amp;= \quad \beta _{ \textrm{tt} } \textrm{Travel Time} _{ \textrm{Swissmetro}} + \\
&amp;\quad \beta _{ \textrm{tc} } \textrm{Travel Cost}_{\textrm{Swissmetro}} * \left( GA == 0 \right) + \\
\\
V_{i, \textrm{Car}} &amp;= \textrm{ASC Car} + \\
&amp;\beta _{ \textrm{tt} } \textrm{Travel Time} _{ \textrm{Car}} + \\
&amp;\quad \beta _{ \textrm{tc}} \textrm{Travel Cost}_{\textrm{Car}} \\
\end{aligned}
$$</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sm_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/swissmetro_long.csv&quot;</span><span class="p">)</span>

<span class="c1"># Update travel time (minutes =&gt; hours)</span>
<span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_time&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="c1"># Get free_ticket</span>
<span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;free_ticket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;GA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;WHO&quot;</span><span class="p">]</span><span class="o">/</span> <span class="mf">100.0</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
                            <span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;mode_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># Update travel cost</span>
<span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">sm_long</span><span class="p">[</span><span class="s2">&quot;free_ticket&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spec</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;travel_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
<span class="n">spec</span><span class="p">[</span><span class="s2">&quot;travel_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sm_mnl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">create_choice_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sm_long</span><span class="p">,</span>
                                <span class="n">alt_id_col</span><span class="o">=</span><span class="s2">&quot;mode_id&quot;</span><span class="p">,</span>
                                <span class="n">obs_id_col</span><span class="o">=</span><span class="s2">&quot;custom_id&quot;</span><span class="p">,</span>
                                <span class="n">choice_col</span><span class="o">=</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">,</span>
                                <span class="n">specification</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;MNL&quot;</span><span class="p">)</span>

<span class="c1"># Specify the initial values and method for the optimization.</span>
<span class="n">sm_mnl</span><span class="o">.</span><span class="n">fit_mle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Look at the estimation results</span>
<span class="n">sm_mnl</span><span class="o">.</span><span class="n">get_statsmodels_summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Log-likelihood at zero: -6,964.6630
Initial Log-likelihood: -6,964.6630
Estimation Time for Point Estimation: 0.03 seconds.
Final log-likelihood: -5,331.2520
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/danph/anaconda3/envs/ml-dchoice/lib/python3.7/site-packages/scipy/optimize/_minimize.py:523: RuntimeWarning: Method BFGS does not use Hessian information (hess).
  RuntimeWarning)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<table class="simpletable">
<caption>Multinomial Logit Model Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>         <td>CHOICE</td>          <th>  No. Observations:  </th>    <td>6,768</td>  
</tr>
<tr>
  <th>Model:</th>         <td>Multinomial Logit Model</td> <th>  Df Residuals:      </th>    <td>6,764</td>  
</tr>
<tr>
  <th>Method:</th>                  <td>MLE</td>           <th>  Df Model:          </th>      <td>4</td>    
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 11 Mar 2021</td>     <th>  Pseudo R-squ.:     </th>    <td>0.235</td>  
</tr>
<tr>
  <th>Time:</th>                 <td>18:37:20</td>         <th>  Pseudo R-bar-squ.: </th>    <td>0.234</td>  
</tr>
<tr>
  <th>AIC:</th>                 <td>10,670.504</td>        <th>  Log-Likelihood:    </th> <td>-5,331.252</td>
</tr>
<tr>
  <th>BIC:</th>                 <td>10,697.784</td>        <th>  LL-Null:           </th> <td>-6,964.663</td>
</tr>
</table>
<table class="simpletable">
<tr>
            <td></td>               <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>intercept_3</th>           <td>   -0.1546</td> <td>    0.043</td> <td>   -3.577</td> <td> 0.000</td> <td>   -0.239</td> <td>   -0.070</td>
</tr>
<tr>
  <th>intercept_1</th>           <td>   -0.7012</td> <td>    0.055</td> <td>  -12.778</td> <td> 0.000</td> <td>   -0.809</td> <td>   -0.594</td>
</tr>
<tr>
  <th>travel_cost_[1, 2, 3]</th> <td>   -1.0838</td> <td>    0.052</td> <td>  -20.910</td> <td> 0.000</td> <td>   -1.185</td> <td>   -0.982</td>
</tr>
<tr>
  <th>travel_time_[1, 2, 3]</th> <td>   -1.2779</td> <td>    0.057</td> <td>  -22.465</td> <td> 0.000</td> <td>   -1.389</td> <td>   -1.166</td>
</tr>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">model_pred</span><span class="p">(</span><span class="n">sm_long</span><span class="p">,</span> <span class="n">sm_mnl</span><span class="p">,</span> <span class="n">alt_id_column</span><span class="p">,</span> <span class="n">obs_id_column</span><span class="p">,</span> <span class="n">choice_column</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>              precision    recall  f1-score   support

           1       0.83      0.01      0.01       908
           2       0.68      0.92      0.78      4090
           3       0.68      0.46      0.55      1770

    accuracy                           0.68      6768
   macro avg       0.73      0.46      0.45      6768
weighted avg       0.70      0.68      0.62      6768

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">),</span> 
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">, F1_score = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Accuracy = [0.67642], F1_score = 0.61537
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

