---

title: MNL from scratch

keywords: fastai
sidebar: home_sidebar

summary: "API details."
description: "API details."
nb_path: "04_MNL_from_scratch.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_MNL_from_scratch.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="say_hello" class="doc_header"><code>say_hello</code><a href="https://github.com/danhphan/choicenet/tree/master/choicenet/MNL_from_scratch.py#L6" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>say_hello</code>(<strong><code>to</code></strong>)</p>
</blockquote>
<p>Say hello to somebody</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Choice Net&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;Hello Choice Net!&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Choice Net&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Hello Choice Net!&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="GPU">GPU<a class="anchor-link" href="#GPU"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
<span class="kn">from</span> <span class="nn">numpy.core.umath_tests</span> <span class="kn">import</span> <span class="n">inner1d</span>


<span class="k">def</span> <span class="nf">initialize_gpu</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">cudamat</span> <span class="kn">import</span> <span class="n">cudamat</span> <span class="k">as</span> <span class="n">cm</span>
    <span class="k">global</span> <span class="n">cm</span>

    <span class="c1"># this class wraps matrix operations so that you can switch between numpy</span>
    <span class="c1"># and cuda operations</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">cuda_set_device</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># the keyword &quot;inplace&quot; for all of these functions re-uses the memory wherever</span>
<span class="c1"># possible use this if you don&#39;t want allocate more memory on the gpu which can</span>
<span class="c1"># be expensive, and don&#39;t need to reuse the matrix being transformed</span>


<span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>&lt;ipython-input-3-237271813547&gt;:3: DeprecationWarning: numpy.core.umath_tests is an internal NumPy module and should not be imported. It will be removed in a future NumPy release.
  from numpy.core.umath_tests import inner1d
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">initialize_gpu</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;function __main__.initialize_gpu()&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="PMAT">PMAT<a class="anchor-link" href="#PMAT"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">PMAT</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span> <span class="ow">and</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">CUDAMatrix</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># find the first positive value along an axis - for use in doing random</span>
    <span class="c1"># choice</span>
    <span class="k">def</span> <span class="nf">firstpositive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="c1"># elif self.typ == &#39;cuda&#39;:</span>
        <span class="c1">#  return PMAT(misc.cumsum(self.mat,axis=axis))</span>

    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">argmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">))</span>
        <span class="c1"># WARNING, always in place</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowlen</span><span class="p">,</span> <span class="n">collen</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rowlen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">rowlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">collen</span>
        <span class="k">if</span> <span class="n">collen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">collen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">rowlen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="p">(</span><span class="n">rowlen</span><span class="p">,</span> <span class="n">collen</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># WARNING, always in place</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rowlen</span><span class="p">,</span> <span class="n">collen</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">size</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">shorten</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="c1"># this is weird, but a numpy sum return flat array sometimes and</span>
            <span class="c1"># we want 2D matrices</span>
            <span class="c1"># return PMAT(np.sum(self.mat,axis=axis,dtype=&quot;float64&quot;))</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="c1"># return</span>
            <span class="c1"># PMAT(np.array(np.matrix(self.mat).sum(axis=axis,dtype=&quot;float64&quot;)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">-</span> <span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">divide_by_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowvec</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">/</span> <span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_row</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_row</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multiply_by_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowvec</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">*</span> <span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_row</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_row</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">multiply_by_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colvec</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">*</span> <span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_col</span><span class="p">(</span><span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult_by_col</span><span class="p">(</span><span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_row_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowvec</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">+</span> <span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add_row_vec</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add_row_vec</span><span class="p">(</span><span class="n">rowvec</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_col_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colvec</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">+</span> <span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add_col_vec</span><span class="p">(</span><span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add_col_vec</span><span class="p">(</span><span class="n">colvec</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">element_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">*</span> <span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">element_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">+</span> <span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clamptomin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;numpy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">inftoval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;numpy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">nantoval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;numpy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mat</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="MNL">MNL<a class="anchor-link" href="#MNL"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>

<span class="c1"># from . import pmat</span>
<span class="c1"># from .pmat import PMAT</span>

<span class="c1"># from ..utils.logutil import log_start_finish</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># right now MNL can only estimate location choice models, where every equation</span>
<span class="c1"># is the same</span>
<span class="c1"># it might be better to use stats models for a non-location choice problem</span>

<span class="c1"># data should be column matrix of dimensions NUMVARS x (NUMALTS*NUMOBVS)</span>
<span class="c1"># beta is a row vector of dimensions 1 X NUMVARS</span>


<span class="k">def</span> <span class="nf">mnl_probs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">numalts</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start: calculate MNL probabilities&#39;</span><span class="p">)</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numalts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Number of alternatives is zero&quot;</span><span class="p">)</span>
    <span class="n">utilities</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numalts</span><span class="p">,</span> <span class="n">utilities</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">numalts</span><span class="p">)</span>

    <span class="c1"># https://stats.stackexchange.com/questions/304758/softmax-overflow</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">exponentiated_utility</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">inftoval</span><span class="p">(</span><span class="mf">1e20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">clamptomin</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>
    <span class="n">sum_exponentiated_utility</span> <span class="o">=</span> <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">exponentiated_utility</span><span class="o">.</span><span class="n">divide_by_row</span><span class="p">(</span>
        <span class="n">sum_exponentiated_utility</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">nantoval</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">clamptomin</span><span class="p">(</span><span class="mf">1e-300</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: calculate MNL probabilities&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probs</span>


<span class="k">def</span> <span class="nf">get_hessian</span><span class="p">(</span><span class="n">derivative</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivative</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">derivative</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">get_standard_error</span><span class="p">(</span><span class="n">hessian</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">hessian</span><span class="p">))</span>

<span class="c1"># data should be column matrix of dimensions NUMVARS x (NUMALTS*NUMOBVS)</span>
<span class="c1"># beta is a row vector of dimensions 1 X NUMVARS</span>


<span class="k">def</span> <span class="nf">mnl_loglik</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">stderr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;start: calculate MNL log-likelihood&#39;</span><span class="p">)</span>
    <span class="n">numvars</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span>
    <span class="n">numobs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">numvars</span> <span class="o">//</span> <span class="n">numalts</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">typ</span><span class="p">)</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="n">mnl_probs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">numalts</span><span class="p">)</span>

    <span class="c1"># lcgrad is the special gradient for the latent class membership model</span>
    <span class="k">if</span> <span class="n">lcgrad</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">weights</span>
        <span class="n">gradmat</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">gradmat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">gradmat</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradmat</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span>
                <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">gradmat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
        <span class="n">gradmat</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span><span class="n">gradmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gradmat</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
        <span class="n">gradmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numvars</span><span class="p">,</span> <span class="n">numalts</span> <span class="o">*</span> <span class="n">numobs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_standard_error</span><span class="p">(</span><span class="n">get_hessian</span><span class="p">(</span><span class="n">gradmat</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()))</span>

    <span class="n">chosen</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">numalts</span><span class="p">,</span> <span class="n">numobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span> <span class="o">==</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">():</span>
            <span class="n">loglik</span> <span class="o">=</span> <span class="p">((</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loglik</span> <span class="o">=</span> <span class="p">((</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">multiply_by_row</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                      <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loglik</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">element_multiply</span><span class="p">(</span>
            <span class="n">chosen</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">loglik</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
        <span class="n">loglik</span><span class="p">,</span> <span class="n">gradarr</span> <span class="o">=</span> <span class="n">loglik</span><span class="o">.</span><span class="n">get_mat</span><span class="p">(),</span> <span class="n">gradarr</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loglik</span> <span class="o">=</span> <span class="n">loglik</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gradarr</span><span class="o">.</span><span class="n">get_mat</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gradarr</span><span class="o">.</span><span class="n">size</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: calculate MNL log-likelihood&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">loglik</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">gradarr</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mnl_simulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">GPU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnprobs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the probabilities for each chooser choosing between `numalts`</span>
<span class="sd">    alternatives.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : 2D array</span>
<span class="sd">        The data are expected to be in &quot;long&quot; form where each row is for</span>
<span class="sd">        one alternative. Alternatives are in groups of `numalts` rows per</span>
<span class="sd">        choosers. Alternatives must be in the same order for each chooser.</span>
<span class="sd">    coeff : 1D array</span>
<span class="sd">        The model coefficients corresponding to each column in `data`.</span>
<span class="sd">    numalts : int</span>
<span class="sd">        The number of alternatives available to each chooser.</span>
<span class="sd">    GPU : bool, optional</span>
<span class="sd">    returnprobs : bool, optional</span>
<span class="sd">        If True, return the probabilities for each chooser/alternative instead</span>
<span class="sd">        of actual choices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    probs or choices: 2D array</span>
<span class="sd">        If `returnprobs` is True the probabilities are a 2D array with a</span>
<span class="sd">        row for each chooser and columns for each alternative.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;start: MNL simulation with len(data)=</span><span class="si">{}</span><span class="s1"> and numalts=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">numalts</span><span class="p">))</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">GPU</span> <span class="k">else</span> <span class="s1">&#39;cuda&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeff</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">)))</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atype</span><span class="p">),</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="n">mnl_probs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">numalts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">returnprobs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">get_mat</span><span class="p">())</span>

    <span class="c1"># convert to cpu from here on - gpu doesn&#39;t currently support these ops</span>
    <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">get_mat</span><span class="p">())</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pmat</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="n">numalts</span><span class="p">)</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">firstpositive</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: MNL simulation&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">choices</span><span class="o">.</span><span class="n">get_mat</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mnl_estimate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">GPU</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coeffrange</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                 <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate coefficients of the MNL model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : 2D array</span>
<span class="sd">        The data are expected to be in &quot;long&quot; form where each row is for</span>
<span class="sd">        one alternative. Alternatives are in groups of `numalts` rows per</span>
<span class="sd">        choosers. Alternatives must be in the same order for each chooser.</span>
<span class="sd">    chosen : 2D array</span>
<span class="sd">        This boolean array has a row for each chooser and a column for each</span>
<span class="sd">        alternative. The column ordering for alternatives is expected to be</span>
<span class="sd">        the same as their row ordering in the `data` array.</span>
<span class="sd">        A one (True) indicates which alternative each chooser has chosen.</span>
<span class="sd">    numalts : int</span>
<span class="sd">        The number of alternatives.</span>
<span class="sd">    GPU : bool, optional</span>
<span class="sd">    coeffrange : tuple of floats, optional</span>
<span class="sd">        Limits of (min, max) to which coefficients are clipped.</span>
<span class="sd">    weights : ndarray, optional</span>
<span class="sd">    lcgrad : bool, optional</span>
<span class="sd">    beta : 1D array, optional</span>
<span class="sd">        Any initial guess for the coefficients.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    log_likelihood : dict</span>
<span class="sd">        Dictionary of log-likelihood values describing the quality of</span>
<span class="sd">        the model fit.</span>
<span class="sd">    fit_parameters : pandas.DataFrame</span>
<span class="sd">        Table of fit parameters with columns &#39;Coefficient&#39;, &#39;Std. Error&#39;,</span>
<span class="sd">        &#39;T-Score&#39;. Each row corresponds to a column in `data` and are given</span>
<span class="sd">        in the same order as in `data`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    scipy.optimize.fmin_l_bfgs_b : The optimization routine used.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;start: MNL fit with len(data)=</span><span class="si">{}</span><span class="s1"> and numalts=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">numalts</span><span class="p">))</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">GPU</span> <span class="k">else</span> <span class="s1">&#39;cuda&#39;</span>

    <span class="n">numvars</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">numobs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">numalts</span>

    <span class="k">if</span> <span class="n">chosen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">numobs</span><span class="p">,</span> <span class="n">numalts</span><span class="p">))</span>  <span class="c1"># used for latent classes</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>

    <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">atype</span><span class="p">),</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">PMAT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">atype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numvars</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">coeffrange</span><span class="p">]</span> <span class="o">*</span> <span class="n">numvars</span>

    <span class="k">with</span> <span class="n">log_start_finish</span><span class="p">(</span><span class="s1">&#39;scipy optimization for MNL fit&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">lcgrad</span><span class="p">)</span>
        <span class="n">bfgs_result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span><span class="p">(</span><span class="n">mnl_loglik</span><span class="p">,</span>
                                                   <span class="n">beta</span><span class="p">,</span>
                                                   <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                                   <span class="n">fprime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                   <span class="n">factr</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                   <span class="n">approx_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span>
                                                   <span class="p">)</span>

    <span class="k">if</span> <span class="n">bfgs_result</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;warnflag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;mnl did not converge correctly: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">bfgs_result</span><span class="p">)</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">bfgs_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">mnl_loglik</span><span class="p">(</span>
        <span class="n">beta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">numalts</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lcgrad</span><span class="o">=</span><span class="n">lcgrad</span><span class="p">)</span>

    <span class="n">l0beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numvars</span><span class="p">)</span>
    <span class="n">l0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">mnl_loglik</span><span class="p">(</span><span class="n">l0beta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">mnl_loglik</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;null&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">l0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">l1</span> <span class="o">/</span> <span class="n">l0</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Coefficient&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;Std. Error&#39;</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span>
        <span class="s1">&#39;T-Score&#39;</span><span class="p">:</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">stderr</span><span class="p">})</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;finish: MNL fit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">fit_parameters</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="TESTING">TESTING<a class="anchor-link" href="#TESTING"> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvmodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/travel_mode.csv&#39;</span><span class="p">)</span>
<span class="n">tvchoice</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/travel_choosers.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvmodes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">tvchoice</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((840, 10), (8, 10))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvmodes</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>individual</th>
      <th>mode</th>
      <th>choice</th>
      <th>wait</th>
      <th>vcost</th>
      <th>travel</th>
      <th>gcost</th>
      <th>income</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.air</td>
      <td>1</td>
      <td>air</td>
      <td>False</td>
      <td>69</td>
      <td>59</td>
      <td>100</td>
      <td>70</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.train</td>
      <td>1</td>
      <td>train</td>
      <td>False</td>
      <td>34</td>
      <td>31</td>
      <td>372</td>
      <td>71</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.bus</td>
      <td>1</td>
      <td>bus</td>
      <td>False</td>
      <td>35</td>
      <td>25</td>
      <td>417</td>
      <td>70</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.car</td>
      <td>1</td>
      <td>car</td>
      <td>True</td>
      <td>0</td>
      <td>10</td>
      <td>180</td>
      <td>30</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.air</td>
      <td>2</td>
      <td>air</td>
      <td>False</td>
      <td>64</td>
      <td>58</td>
      <td>68</td>
      <td>68</td>
      <td>30</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvchoice</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>individual</th>
      <th>mode</th>
      <th>choice</th>
      <th>wait</th>
      <th>vcost</th>
      <th>travel</th>
      <th>gcost</th>
      <th>income</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>107.air</td>
      <td>107</td>
      <td>air</td>
      <td>False</td>
      <td>69</td>
      <td>108</td>
      <td>180</td>
      <td>128</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>107.train</td>
      <td>107</td>
      <td>train</td>
      <td>False</td>
      <td>34</td>
      <td>89</td>
      <td>901</td>
      <td>187</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>107.bus</td>
      <td>107</td>
      <td>bus</td>
      <td>False</td>
      <td>35</td>
      <td>44</td>
      <td>891</td>
      <td>141</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>107.car</td>
      <td>107</td>
      <td>car</td>
      <td>True</td>
      <td>0</td>
      <td>34</td>
      <td>720</td>
      <td>112</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>182.air</td>
      <td>182</td>
      <td>air</td>
      <td>False</td>
      <td>69</td>
      <td>59</td>
      <td>121</td>
      <td>72</td>
      <td>26</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>182.train</td>
      <td>182</td>
      <td>train</td>
      <td>False</td>
      <td>34</td>
      <td>31</td>
      <td>386</td>
      <td>73</td>
      <td>26</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>182.bus</td>
      <td>182</td>
      <td>bus</td>
      <td>False</td>
      <td>35</td>
      <td>25</td>
      <td>431</td>
      <td>72</td>
      <td>26</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>182.car</td>
      <td>182</td>
      <td>car</td>
      <td>True</td>
      <td>0</td>
      <td>14</td>
      <td>270</td>
      <td>43</td>
      <td>26</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dm</span> <span class="o">=</span> <span class="n">tvmodes</span>
<span class="c1"># chosen = </span>
<span class="c1"># num_alts = </span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-cyan-fg">  File </span><span class="ansi-green-fg">&#34;&lt;ipython-input-31-4ec9bba80912&gt;&#34;</span><span class="ansi-cyan-fg">, line </span><span class="ansi-green-fg">2</span>
<span class="ansi-red-fg">    chosen =</span>
             ^
<span class="ansi-red-fg">SyntaxError</span><span class="ansi-red-fg">:</span> invalid syntax
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">log_like</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">mnl_estimate</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">num_alts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_mnl_estimate</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">num_alts</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="n">log_like</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">mnl</span><span class="o">.</span><span class="n">mnl_estimate</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">num_alts</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">Coefficient</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;est_expected&#39;</span><span class="p">])</span>
    <span class="n">npt</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvmodes</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>individual</th>
      <th>mode</th>
      <th>choice</th>
      <th>wait</th>
      <th>vcost</th>
      <th>travel</th>
      <th>gcost</th>
      <th>income</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.air</td>
      <td>1</td>
      <td>air</td>
      <td>False</td>
      <td>69</td>
      <td>59</td>
      <td>100</td>
      <td>70</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.train</td>
      <td>1</td>
      <td>train</td>
      <td>False</td>
      <td>34</td>
      <td>31</td>
      <td>372</td>
      <td>71</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.bus</td>
      <td>1</td>
      <td>bus</td>
      <td>False</td>
      <td>35</td>
      <td>25</td>
      <td>417</td>
      <td>70</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.car</td>
      <td>1</td>
      <td>car</td>
      <td>True</td>
      <td>0</td>
      <td>10</td>
      <td>180</td>
      <td>30</td>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.air</td>
      <td>2</td>
      <td>air</td>
      <td>False</td>
      <td>64</td>
      <td>58</td>
      <td>68</td>
      <td>68</td>
      <td>30</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tvmodes</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-32-067c0e7868ae&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>tvmodes<span class="ansi-blue-fg">[</span>columns<span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">~/anaconda3/envs/dev/lib/python3.8/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">__getitem__</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-intense-fg ansi-bold">   2910</span>             <span class="ansi-green-fg">if</span> is_iterator<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   2911</span>                 key <span class="ansi-blue-fg">=</span> list<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 2912</span><span class="ansi-red-fg">             </span>indexer <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>loc<span class="ansi-blue-fg">.</span>_get_listlike_indexer<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> raise_missing<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   2913</span> 
<span class="ansi-green-intense-fg ansi-bold">   2914</span>         <span class="ansi-red-fg"># take() does not accept boolean indexers</span>

<span class="ansi-green-fg">~/anaconda3/envs/dev/lib/python3.8/site-packages/pandas/core/indexing.py</span> in <span class="ansi-cyan-fg">_get_listlike_indexer</span><span class="ansi-blue-fg">(self, key, axis, raise_missing)</span>
<span class="ansi-green-intense-fg ansi-bold">   1252</span>             keyarr<span class="ansi-blue-fg">,</span> indexer<span class="ansi-blue-fg">,</span> new_indexer <span class="ansi-blue-fg">=</span> ax<span class="ansi-blue-fg">.</span>_reindex_non_unique<span class="ansi-blue-fg">(</span>keyarr<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1253</span> 
<span class="ansi-green-fg">-&gt; 1254</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_validate_read_indexer<span class="ansi-blue-fg">(</span>keyarr<span class="ansi-blue-fg">,</span> indexer<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">,</span> raise_missing<span class="ansi-blue-fg">=</span>raise_missing<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1255</span>         <span class="ansi-green-fg">return</span> keyarr<span class="ansi-blue-fg">,</span> indexer
<span class="ansi-green-intense-fg ansi-bold">   1256</span> 

<span class="ansi-green-fg">~/anaconda3/envs/dev/lib/python3.8/site-packages/pandas/core/indexing.py</span> in <span class="ansi-cyan-fg">_validate_read_indexer</span><span class="ansi-blue-fg">(self, key, indexer, axis, raise_missing)</span>
<span class="ansi-green-intense-fg ansi-bold">   1296</span>             <span class="ansi-green-fg">if</span> missing <span class="ansi-blue-fg">==</span> len<span class="ansi-blue-fg">(</span>indexer<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1297</span>                 axis_name <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>obj<span class="ansi-blue-fg">.</span>_get_axis_name<span class="ansi-blue-fg">(</span>axis<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1298</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">raise</span> KeyError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#34;None of [{key}] are in the [{axis_name}]&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1299</span> 
<span class="ansi-green-intense-fg ansi-bold">   1300</span>             <span class="ansi-red-fg"># We (temporarily) allow for some missing keys with .loc, except in</span>

<span class="ansi-red-fg">KeyError</span>: &#34;None of [Index([&#39;air&#39;, &#39;train&#39;, &#39;bus&#39;, &#39;car&#39;], dtype=&#39;object&#39;)] are in the [columns]&#34;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

