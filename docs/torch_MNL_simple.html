---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "02_torch_MNL_simple.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_torch_MNL_simple.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/swissmetro_train.csv&quot;</span><span class="p">)</span>
<span class="n">df_valid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/swissmetro_valid.csv&quot;</span><span class="p">)</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df_valid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>((7484, 28), (1604, 28))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ChoiceDataset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">atts_cols</span><span class="p">,</span> <span class="n">avai_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data: the choice data frame</span>
<span class="sd">        :param atts_cols: attribute columns of alternatives (like travel time, cost)</span>
<span class="sd">        :param avail_cols: availability columns of alternatives</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atts_cols</span> <span class="o">=</span> <span class="n">atts_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avai_cols</span> <span class="o">=</span> <span class="n">avai_cols</span>
        <span class="c1"># Store numpy array of alternative attributes and availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">atts_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">avai_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> 
        <span class="c1"># Store column name and its corresponding column index of attribute variables and availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">att</span><span class="p">:</span><span class="n">idx</span> <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">)))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avai_idxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">av</span><span class="p">:</span><span class="n">idx</span>  <span class="k">for</span> <span class="n">av</span><span class="p">,</span> <span class="n">idx</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">avai_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avai_cols</span><span class="p">)))}</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avai</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="s2">&quot;av&quot;</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>

<span class="k">class</span> <span class="nc">MNL</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atts_idxs</span><span class="p">,</span> <span class="n">avai_idxs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MNL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span> <span class="o">=</span> <span class="n">atts_idxs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avai_idxs</span> <span class="o">=</span> <span class="n">avai_idxs</span>
        <span class="c1"># Initiate parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASC_TRAIN</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((),</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASC_CAR</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((),</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_TIME</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((),</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B_COST</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((),</span> <span class="mf">0.1</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">av</span><span class="p">):</span>
        <span class="c1"># Calculate V</span>
        <span class="n">V1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASC_TRAIN</span> <span class="o">+</span> 
              <span class="bp">self</span><span class="o">.</span><span class="n">B_TIME</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_TT&quot;</span><span class="p">]]</span> <span class="o">+</span> 
              <span class="bp">self</span><span class="o">.</span><span class="n">B_COST</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_CO&quot;</span><span class="p">]])</span>
        <span class="n">V2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TIME</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;SM_TT&quot;</span><span class="p">]]</span> <span class="o">+</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">B_COST</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;SM_CO&quot;</span><span class="p">]])</span>
        <span class="n">V3</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASC_CAR</span> <span class="o">+</span> 
              <span class="bp">self</span><span class="o">.</span><span class="n">B_TIME</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;CAR_TT&quot;</span><span class="p">]]</span> <span class="o">+</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">B_COST</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;CAR_CO&quot;</span><span class="p">]])</span>
        <span class="c1"># Join with availability</span>
        <span class="n">V1</span> <span class="o">=</span> <span class="n">V1</span> <span class="o">*</span> <span class="n">av</span><span class="p">[:,</span> <span class="n">avai_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_AV&quot;</span><span class="p">]]</span>
        <span class="n">V2</span> <span class="o">=</span> <span class="n">V2</span> <span class="o">*</span> <span class="n">av</span><span class="p">[:,</span> <span class="n">avai_idxs</span><span class="p">[</span><span class="s2">&quot;SM_AV&quot;</span><span class="p">]]</span>
        <span class="n">V3</span> <span class="o">=</span> <span class="n">V3</span> <span class="o">*</span> <span class="n">av</span><span class="p">[:,</span> <span class="n">avai_idxs</span><span class="p">[</span><span class="s2">&quot;CAR_AV&quot;</span><span class="p">]]</span>
        <span class="c1"># Concat into one matrix</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">V1</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">V2</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">V3</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Get probality and loglikelihood</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">probs</span>
    
    <span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ASC_TRAIN=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ASC_TRAIN</span><span class="si">}</span><span class="s1">, ASC_CAR=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ASC_CAR</span><span class="si">}</span><span class="s1">, B_TIME=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">B_TIME</span><span class="si">}</span><span class="s1">, B_COST=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">B_COST</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atts_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TRAIN_TT&#39;</span><span class="p">,</span> <span class="s1">&#39;TRAIN_CO&#39;</span><span class="p">,</span><span class="s1">&#39;SM_TT&#39;</span><span class="p">,</span> <span class="s1">&#39;SM_CO&#39;</span><span class="p">,</span> <span class="s1">&#39;CAR_TT&#39;</span><span class="p">,</span> <span class="s1">&#39;CAR_CO&#39;</span><span class="p">]</span>
<span class="n">avai_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TRAIN_AV&#39;</span><span class="p">,</span> <span class="s1">&#39;CAR_AV&#39;</span><span class="p">,</span> <span class="s1">&#39;SM_AV&#39;</span><span class="p">]</span>

<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">atts_cols</span><span class="p">,</span> <span class="n">avai_cols</span><span class="p">)</span>
<span class="n">ds_valid</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="p">(</span><span class="n">df_valid</span><span class="p">,</span> <span class="n">atts_cols</span><span class="p">,</span> <span class="n">avai_cols</span><span class="p">)</span>

<span class="n">atts_idxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">att</span><span class="p">:</span><span class="n">idx</span> <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">)))}</span>
<span class="n">avai_idxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">av</span><span class="p">:</span><span class="n">idx</span>  <span class="k">for</span> <span class="n">av</span><span class="p">,</span> <span class="n">idx</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">avai_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avai_cols</span><span class="p">)))}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MNL</span><span class="p">(</span><span class="n">atts_idxs</span><span class="p">,</span> <span class="n">avai_idxs</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">ds_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">ds_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">batch</span><span class="p">][</span><span class="s2">&quot;av&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[7.4603e-04, 2.2645e-07, 9.9925e-01],
        [7.4984e-01, 5.5982e-04, 2.4960e-01],
        [9.9593e-01, 4.0701e-03, 5.5944e-10],
        [3.9737e-01, 9.8244e-03, 5.9281e-01],
        [2.5306e-11, 5.1756e-17, 1.0000e+00],
        [9.9997e-01, 4.5516e-06, 2.2544e-05],
        [5.9152e-01, 1.1973e-02, 3.9651e-01],
        [9.9424e-01, 5.4848e-03, 2.7307e-04],
        [9.9044e-01, 5.4780e-04, 9.0084e-03],
        [7.3033e-01, 2.6867e-01, 9.9352e-04],
        [9.8523e-01, 1.4774e-02, 6.7074e-07],
        [6.6922e-03, 9.0804e-05, 9.9322e-01],
        [9.8560e-01, 5.4371e-03, 8.9643e-03],
        [       nan,        nan, 0.0000e+00],
        [       nan,        nan, 0.0000e+00],
        [4.2539e-01, 3.8791e-04, 5.7422e-01]], grad_fn=&lt;DivBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl_train</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dl_valid</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds_valid</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds_train</span><span class="o">.</span><span class="n">atts_idxs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;TRAIN_TT&#39;: 0,
 &#39;TRAIN_CO&#39;: 1,
 &#39;SM_TT&#39;: 2,
 &#39;SM_CO&#39;: 3,
 &#39;CAR_TT&#39;: 4,
 &#39;CAR_CO&#39;: 5}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">{</span><span class="n">att</span><span class="p">:</span><span class="n">idx</span> <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atts_cols</span><span class="p">)))}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;TRAIN_TT&#39;: 0,
 &#39;TRAIN_CO&#39;: 1,
 &#39;SM_TT&#39;: 2,
 &#39;SM_CO&#39;: 3,
 &#39;CAR_TT&#39;: 4,
 &#39;CAR_CO&#39;: 5}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_train</span><span class="p">[</span><span class="n">atts_cols</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Index([&#39;TRAIN_TT&#39;, &#39;TRAIN_CO&#39;, &#39;SM_TT&#39;, &#39;SM_CO&#39;, &#39;CAR_TT&#39;, &#39;CAR_CO&#39;], dtype=&#39;object&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_arr</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">atts_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">train_arr</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(7484, 6)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([182, 111,  81, 132, 210, 155])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">train_arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_arr</span><span class="p">[:,</span> <span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_TT&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;TRAIN_TT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([ True,  True,  True, ...,  True,  True,  True])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_arr</span><span class="p">[:,</span> <span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_TT&quot;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([182, 132, 220, ..., 283, 148, 170])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ts</span><span class="p">[:,</span> <span class="n">atts_idxs</span><span class="p">[</span><span class="s2">&quot;TRAIN_TT&quot;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([182., 132., 220.,  ..., 283., 148., 170.])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">atts_cols</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">train_arr</span><span class="p">[:,</span> <span class="n">atts_idxs</span><span class="p">[</span><span class="n">col</span><span class="p">]],</span><span class="n">df_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TRAIN_TT True
TRAIN_CO True
SM_TT True
SM_CO True
CAR_TT True
CAR_CO True
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">nll</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">probs</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>       

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span><span class="n">_10_tastenet_mnl</span><span class="o">.</span><span class="n">ipynb</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">av</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;av&#39;</span><span class="p">]</span>
<span class="c1">#         x = x.to(device, dtype=torch.float32)</span>
<span class="c1">#         av = av.to(device, dtype=torch.float32)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">av</span><span class="p">)</span>        
        <span class="n">loss</span> <span class="o">=</span> <span class="n">nll</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        
        
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">final_targets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">final_outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>        
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;av&#39;</span><span class="p">]</span>
<span class="c1">#             x = x.to(device, dtype=torch.float32)</span>
<span class="c1">#             av = av.to(device, dtype=torch.float32)</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">av</span><span class="p">)</span>        
            <span class="n">final_targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
            <span class="n">final_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

